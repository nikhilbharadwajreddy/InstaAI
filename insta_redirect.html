<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram OAuth Processing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #f7f7f7;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .error-message {
            color: #e74c3c;
            font-weight: bold;
            margin: 20px 0;
        }
        .warning-message {
            color: #f39c12;
            font-weight: bold;
            margin: 20px 0;
        }
        .debug-info {
            text-align: left;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 30px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .success-message {
            color: #2ecc71;
            font-weight: bold;
            margin: 20px 0;
        }
        .token-info {
            text-align: left;
            padding: 15px;
            margin: 10px auto;
            max-width: 500px;
            background-color: #edf7ff;
            border-radius: 5px;
            border: 1px solid #bde5ff;
            font-size: 14px;
        }
        .token-info h3 {
            margin-top: 0;
            color: #3498db;
        }
    </style>
</head>
<body>
    <h1>Connecting your Instagram account...</h1>
    <div class="loader"></div>
    <p id="status-message" class="message">Processing your authorization...</p>
    <div id="token-info-container"></div>
    <div id="success-container"></div>
    <div id="warning-container"></div>
    <div id="error-container"></div>
    <div id="button-container"></div>
    <div id="debug-container" class="debug-info" style="display: none;"></div>

    <script>
        // Debug helper function
        function logDebug(message, data) {
            console.log(message, data);
            
            const debugContainer = document.getElementById("debug-container");
            const logEntry = document.createElement("div");
            
            if (typeof data === 'object') {
                logEntry.textContent = `${message} ${JSON.stringify(data, null, 2)}`;
            } else {
                logEntry.textContent = `${message} ${data || ''}`;
            }
            
            debugContainer.appendChild(logEntry);
            debugContainer.appendChild(document.createElement("hr"));
            debugContainer.style.display = "block";
        }
        
        // Test storage accessibility
        function testStorage() {
            try {
                // Test sessionStorage
                sessionStorage.setItem('test', 'test');
                const sessionTest = sessionStorage.getItem('test');
                sessionStorage.removeItem('test');
                
                // Test localStorage
                localStorage.setItem('test', 'test');
                const localTest = localStorage.getItem('test');
                localStorage.removeItem('test');
                
                logDebug("Storage test:", {
                    sessionStorage: sessionTest === 'test' ? "Working" : "Failed",
                    localStorage: localTest === 'test' ? "Working" : "Failed"
                });
                
                return {
                    sessionStorage: sessionTest === 'test',
                    localStorage: localTest === 'test'
                };
            } catch (error) {
                logDebug("Storage test failed:", error.message);
                return { sessionStorage: false, localStorage: false };
            }
        }
        
        // Function to safely store tokens
        function safelyStoreTokens(accessToken, userId, tokenType, pageId) {
            let sessionStorageSuccess = false;
            let localStorageSuccess = false;
            
            try {
                // Store the token and user ID in sessionStorage
                sessionStorage.setItem('instagram_access_token', accessToken);
                sessionStorage.setItem('instagram_user_id', userId);
                sessionStorage.setItem('instagram_token_type', tokenType || 'unknown');
                if (pageId) sessionStorage.setItem('instagram_page_id', pageId);
                sessionStorageSuccess = true;
                logDebug("Session storage success:", "Tokens stored");
            } catch (sessionError) {
                logDebug("Session storage error:", sessionError.message);
            }
            
            try {
                // Store in localStorage for persistence
                localStorage.setItem('instagram_access_token', accessToken);
                localStorage.setItem('instagram_user_id', userId);
                localStorage.setItem('instagram_token_type', tokenType || 'unknown');
                if (pageId) localStorage.setItem('instagram_page_id', pageId);
                localStorageSuccess = true;
                logDebug("Local storage success:", "Tokens stored");
            } catch (localError) {
                logDebug("Local storage error:", localError.message);
            }
            
            // Verify storage was successful
            const sessionVerify = sessionStorage.getItem('instagram_access_token') === accessToken;
            const localVerify = localStorage.getItem('instagram_access_token') === accessToken;
            
            logDebug("Storage verification:", {
                sessionStorage: sessionVerify ? "Verified" : "Failed",
                localStorage: localVerify ? "Verified" : "Failed"
            });
            
            return sessionStorageSuccess || localStorageSuccess;
        }
        
        // Display token info
        function displayTokenInfo(data) {
            const tokenInfoContainer = document.getElementById("token-info-container");
            
            const tokenInfo = document.createElement("div");
            tokenInfo.className = "token-info";
            
            let tokenTypeDisplay = "Unknown";
            switch(data.token_type) {
                case "page_token":
                    tokenTypeDisplay = "Facebook Page (preferred)";
                    break;
                case "long_lived_user":
                    tokenTypeDisplay = "Long-lived User";
                    break;
                case "short_lived":
                    tokenTypeDisplay = "Short-lived (limited)";
                    break;
            }
            
            tokenInfo.innerHTML = `
                <h3>Connection Details</h3>
                <p><strong>Account Type:</strong> ${tokenTypeDisplay}</p>
                <p><strong>Account ID:</strong> ${data.user_id}</p>
                ${data.page_id ? `<p><strong>Page ID:</strong> ${data.page_id}</p>` : ''}
                ${data.warning ? `<p><strong>Note:</strong> ${data.warning}</p>` : ''}
            `;
            
            tokenInfoContainer.appendChild(tokenInfo);
        }
        
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");
            const state = urlParams.get("state");
            const error = urlParams.get("error");
            
            const statusMessage = document.getElementById("status-message");
            const errorContainer = document.getElementById("error-container");
            const warningContainer = document.getElementById("warning-container");
            const successContainer = document.getElementById("success-container");
            const buttonContainer = document.getElementById("button-container");
            
            logDebug("URL Parameters:", { 
                code: code ? "Present" : "Not found",
                state: state || "Not found",
                error: error || "Not found"
            });
            
            // Test storage capability early
            const storageStatus = testStorage();
            
            if (error) {
                logDebug("OAuth Error:", error);
                showError("Instagram authentication error: " + error);
                addRetryButton();
                return;
            }
            
            if (!code) {
                showError("No authorization code found in the URL.");
                addRetryButton();
                return;
            }
            
            // Clear any existing tokens
            try {
                sessionStorage.removeItem('instagram_access_token');
                sessionStorage.removeItem('instagram_user_id');
                sessionStorage.removeItem('instagram_token_type');
                sessionStorage.removeItem('instagram_page_id');
                localStorage.removeItem('instagram_access_token');
                localStorage.removeItem('instagram_user_id');
                localStorage.removeItem('instagram_token_type');
                localStorage.removeItem('instagram_page_id');
                logDebug("Cleared existing tokens", "Success");
            } catch (clearError) {
                logDebug("Error clearing tokens:", clearError.message);
            }
            
            // Check if storage is available
            if (!storageStatus.sessionStorage && !storageStatus.localStorage) {
                showError("Browser storage is not available. This may be due to private browsing mode, cookie restrictions, or storage quota limits.");
                addRetryButton();
                return;
            }
            
            statusMessage.textContent = "Exchanging authorization code for access token...";
            
            // Send the code to backend for token exchange
            fetch("https://76pohrq9ej.execute-api.us-east-1.amazonaws.com/prod/exchange-token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                logDebug("Token exchange response status:", response.status);
                
                // Check if the response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug("Token exchange response data:", {
                    access_token: data.access_token ? "Present" : "Missing",
                    user_id: data.user_id || "Missing",
                    token_type: data.token_type || "Unknown",
                    warning: data.warning || "None"
                });
                
                if (data.access_token && data.user_id) {
                    // Display token info first
                    displayTokenInfo(data);
                    
                    // Try to store tokens safely
                    const storageSuccess = safelyStoreTokens(data.access_token, data.user_id, data.token_type, data.page_id);
                    
                    // Show any warnings
                    if (data.warning) {
                        showWarning(data.warning);
                    }
                    
                    if (storageSuccess) {
                        // Show success message
                        showSuccess("Successfully connected to Instagram!");
                        
                        // Store token in backend
                        storeTokenInBackend(data.access_token, data.user_id, data.token_type, data.page_id);
                        
                        // Get base URL for proper redirect
                        const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                        
                        // Show redirect countdown
                        statusMessage.textContent = "Redirecting to dashboard in 5 seconds...";
                        
                        // Redirect with delay
                        setTimeout(() => {
                            window.location.href = baseUrl + "/index.html?login_success=true";
                        }, 5000);
                    } else {
                        showError("Failed to save authentication data to browser storage. Please check your privacy settings and try again.");
                        addRetryButton();
                        
                        // Add manual copy option
                        addManualCopyOption(data.access_token, data.user_id, data.token_type, data.page_id);
                    }
                } else {
                    showError("Invalid response from authentication server: " + 
                        (data.error_message || data.error || "Missing access token"));
                    addRetryButton();
                }
            })
            .catch(error => {
                console.error("Error:", error);
                logDebug("Fetch error:", error.message);
                showError("Error connecting to Instagram: " + error.message);
                addRetryButton();
            });
        };
        
        // Function to display success messages
        function showSuccess(message) {
            const successContainer = document.getElementById("success-container");
            const loader = document.querySelector(".loader");
            
            // Hide the loader
            loader.style.display = "none";
            
            // Show success message
            const successMessage = document.createElement("p");
            successMessage.className = "success-message";
            successMessage.textContent = message;
            successContainer.appendChild(successMessage);
        }
        
        // Function to display warning messages
        function showWarning(message) {
            const warningContainer = document.getElementById("warning-container");
            
            // Show warning message
            const warningMessage = document.createElement("p");
            warningMessage.className = "warning-message";
            warningMessage.textContent = message;
            warningContainer.appendChild(warningMessage);
        }
        
        // Function to display error messages
        function showError(message) {
            const statusMessage = document.getElementById("status-message");
            const errorContainer = document.getElementById("error-container");
            const loader = document.querySelector(".loader");
            
            // Hide the loader
            loader.style.display = "none";
            
            // Update status message
            statusMessage.textContent = "Connection failed";
            
            // Show error message
            const errorMessage = document.createElement("p");
            errorMessage.className = "error-message";
            errorMessage.textContent = message;
            errorContainer.appendChild(errorMessage);
        }
        
        // Function to add a retry button
        function addRetryButton() {
            const buttonContainer = document.getElementById("button-container");
            
            const retryButton = document.createElement("button");
            retryButton.textContent = "Try Again";
            retryButton.addEventListener("click", function() {
                // Get base URL for proper redirect
                const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                window.location.href = baseUrl + "/index.html";
            });
            
            buttonContainer.appendChild(retryButton);
        }
        
        // Function for manual token copy as a last resort
        function addManualCopyOption(token, userId, tokenType, pageId) {
            const debugContainer = document.getElementById("debug-container");
            const manualSection = document.createElement("div");
            manualSection.style.marginTop = "20px";
            manualSection.innerHTML = `
                <h3>Manual Authentication (Advanced)</h3>
                <p>Copy these values and store them manually:</p>
                <div>
                    <strong>Access Token:</strong> 
                    <input type="text" value="${token}" style="width:100%" readonly onClick="this.select();">
                </div>
                <div style="margin-top:10px">
                    <strong>User ID:</strong> 
                    <input type="text" value="${userId}" style="width:100%" readonly onClick="this.select();">
                </div>
                <div style="margin-top:10px">
                    <strong>Token Type:</strong> 
                    <input type="text" value="${tokenType || 'unknown'}" style="width:100%" readonly onClick="this.select();">
                </div>
                ${pageId ? `
                <div style="margin-top:10px">
                    <strong>Page ID:</strong> 
                    <input type="text" value="${pageId}" style="width:100%" readonly onClick="this.select();">
                </div>` : ''}
                <p>Open your browser console (F12) and run these commands:</p>
                <pre>
localStorage.setItem('instagram_access_token', '${token}');
localStorage.setItem('instagram_user_id', '${userId}');
localStorage.setItem('instagram_token_type', '${tokenType || 'unknown'}');
${pageId ? `localStorage.setItem('instagram_page_id', '${pageId}');` : ''}
sessionStorage.setItem('instagram_access_token', '${token}');
sessionStorage.setItem('instagram_user_id', '${userId}');
sessionStorage.setItem('instagram_token_type', '${tokenType || 'unknown'}');
${pageId ? `sessionStorage.setItem('instagram_page_id', '${pageId}');` : ''}
                </pre>
            `;
            debugContainer.appendChild(manualSection);
            debugContainer.style.display = "block";
        }
        
        // Function to store token in backend
        function storeTokenInBackend(token, userId, tokenType, pageId) {
            logDebug("Storing token in backend for user:", userId);
            
            const payload = { 
                access_token: token,
                user_id: userId,
                token_type: tokenType || 'unknown'
            };
            
            if (pageId) {
                payload.page_id = pageId;
            }
            
            fetch("https://76pohrq9ej.execute-api.us-east-1.amazonaws.com/prod/store-token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(response => {
                logDebug("Backend storage response status:", response.status);
                return response.json();
            })
            .then(data => {
                logDebug('Token storage result:', data);
                
                // Display token validation status if available
                if (data.validation) {
                    if (data.validation.valid) {
                        showSuccess("Token validation successful! Your connection should work correctly.");
                    } else {
                        showWarning(`Token validation failed: ${data.validation.reason || 'Unknown reason'}`);
                    }
                }
            })
            .catch(error => {
                logDebug("Error storing token in backend:", error.message);
                showWarning("Warning: Failed to verify token with backend. Connection may be limited.");
            });
        }
    </script>
</body>
</html>